{#
# GNU MediaGoblin -- federated, autonomous media hosting
# Copyright (C) 2011, 2012 MediaGoblin contributors.  See AUTHORS.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-#}
{% extends "mediagoblin/base.html" %}

{% import "/mediagoblin/utils/wtforms.html" as wtforms_util %}
{% block mediagoblin_head %}
  <link  href="{{request.staticdirect('/dogma/css/jquery.calendarPicker.css')}}" rel="stylesheet">
  <script type="text/javascript" src="{{request.staticdirect('/dogma/js/ajax-postalcode-autocomplete/geonamesData.asc')}}"></script>
  <script type="text/javascript" src="{{request.staticdirect('/dogma/js/ajax-postalcode-autocomplete/jsr_class.js')}}"></script>
  <script type="text/javascript" src="{{request.staticdirect('/dogma/js/jquery.calendarPicker.js')}}"></script>
  <script type="text/javascript" src="{{request.staticdirect('/dogma/js/jquery.mousewheel.js')}}"></script>
  <script type="text/javascript" src="{{request.staticdirect('/dogma/js/add_members.js')}}"></script>
  <script type="text/javascript" src="http://api.geonames.org/export/geonamesData.js?username=dogmazic"></script>
  <script type="text/javascript" src="{{ request.staticdirect('/js/collection_form_show.js') }}"></script>
  <script type="text/javascript">
    var thisCalendar = new Array();
    $(function(){
      //calendar
      setDatePicker();
      //postal code
      postalCodeInit();
    });
    var postalcodes;
    function postalCodeInit(){
      // ______________________
      //|                      |
      //| Postal code selector |
      //|______________________|
      parent_div=''
      setDefaultCountry();
      $(".postalcodeInput").blur(function(){
        parent_div = '#'+$(this).parent('div').attr('id');
        if($(parent_div+" .postalcodeInput").attr('value') !=  ''){
           postalCodeLookup();
        }
      })
      $(parent_div+".searchPlace").click(function(){postalCodeLookup()});
    }
    // postalcodes is filled by the JSON callback and used by the mouse event handlers of the suggest box

    // this function will be called by our JSON callback
    // the parameter jData will contain an array with postalcode objects
    function getLocation(jData) {
      if (jData == null) {
        // There was a problem parsing search results
        return;
      }

      // save place array in 'postalcodes' to make it accessible from mouse event handlers

      postalcodes = jData.postalcodes;
          
      if (postalcodes.length > 1 ) {
        $(parent_div+' .suggestBoxElement').css('visibility', 'visible');
        var suggestBoxHTML  = '';
        // iterate over places and build suggest box content
        for (i=0;i< jData.postalcodes.length;i++) {
          // for every postalcode record we create a html div 
          // each div gets an id using the array index for later retrieval 
          // define mouse event handlers to highlight places on mouseover
          // and to select a place on click
          // all events receive the postalcode array index as input parameter
          suggestBoxHTML += "<div class='suggestion'>" + postalcodes[i].countryCode + ' '  + postalcodes[i].postalcode + ' &nbsp;&nbsp; ' + postalcodes[i].placeName  +'</div>' ;
        }
        $(parent_div+' .placeDisplay').html('<small><i>{% trans %}There\'s several cities for this postal code : {%endtrans %}</i></small>');
        $(parent_div+' .suggestBoxElement').html(suggestBoxHTML);
        $(parent_div+' .suggestion').hover(function(){
          $(this).addClass('selected') 
        },
        function(){
          $(this).removeClass('selected') 
        });
        $('.suggestion').click(function(){
           currentChoice = $(this);
           index = $('.suggestion').index(currentChoice);
           fillFields(postalcodes[index].placeName,postalcodes[index].lat,postalcodes[index].lng);
            $(parent_div+' .suggestBoxElement').html('');


        });

      }
       else if(postalcodes.length == 0){
          $(parent_div+' .placeDisplay').html("{% trans %} The postal code is incorrect, or not precise enough (try 75007 instread of 75000) <a id='searchPlace'>Reload</a> {% endtrans %}");
        }
        else {
        if (postalcodes.length == 1) {
          // exactly one place for postalcode
          // directly fill the form, no suggest box required 
          fillFields(postalcodes[0].placeName,postalcodes[0].lat,postalcodes[0].lng);
        }
      }
      function fillFields(place,lat,lng){
          $(parent_div+' .placeInput').attr('value', place);
          $(parent_div+' .latitude').attr('value', lat);
          $(parent_div+' .longitude').attr('value', lng);
          $(parent_div+' .placeDisplay').html(place);
      }
    }


    // this function is called when the user leaves the postal code input field
    // it call the geonames.org JSON webservice to fetch an array of places 
    // for the given postal code 
    function postalCodeLookup() {

      var country = $(parent_div+' .countrySelect').attr('value');

      if (geonamesPostalCodeCountries.toString().search(country) == -1) {
         return; // selected country not supported by geonames
      }
      // display loading in suggest box
      $(parent_div+' .placeDisplay').html('<small><i>{% trans %}loading ...{% endtrans %}</i></small>');

      var postalcode = $(parent_div+' .postalcodeInput').attr('value');

      request = 'http://api.geonames.org/postalCodeLookupJSON?postalcode=' + postalcode  + '&country=' + country  + '&username=dogmazic&callback=getLocation';

      // Create a new script object
      aObj = new JSONscriptRequest(request);
      // Build the script tag
      aObj.buildScriptTag();
      // Execute (add) the script tag
      aObj.addScriptTag();
    }

    // set the country of the user's ip (included in geonamesData.js) as selected country 
    // in the country select box of the address form
    function setDefaultCountry() {
      var countrySelect = $(parent_div+' .countrySelect');
      for (i=0;i< countrySelect.length;i++) {
        // the javascript geonamesData.js contains the countrycode
        // of the userIp in the variable 'geonamesUserIpCountryCode'
        if (countrySelect[i].value ==  geonamesUserIpCountryCode) {
          // set the country selectionfield
          countrySelect.selectedIndex = i;
        }
      }
    }

      // ______________________
      //|                      |
      //|     Date picker      |
      //|______________________|
      function setDatePicker(){
        $(".dateUnprocessed").each(function(index){
          console.debug(index);
          console.debug(thisCalendar.length);
          $(this).removeClass("dateUnprocessed");
          if(index < thisCalendar.length){
            index = thisCalendar.length;
          }
          thisCalendar[index] = $(this);
          $(this).calendarPicker({
            monthNames:["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
            dayNames: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
            useWheel:true,
            callbackDelay:500,
            years:4,
            months:5,
            days:6,
            showDayArrows:true,
            callback:function(cal){
                //thisCalendar[index].find(".calElement.selected").attr("millis"));
                thisCalendar[index].children(".date_picker_input").attr('value',
                cal.currentDate.getFullYear()+'-'+(cal.currentDate.getMonth()+1)
                +'-'+cal.currentDate.getDate());
            }
          });
        });
      }

  </script>
{% endblock %}



{% block title -%}
  {% trans %}Add your media{% endtrans %} &mdash; {{ super() }}
{%- endblock %}
{% block mediagoblin_content %}
  <h1>{% trans %}Create a new Band{% endtrans %}</h1>
  <form enctype="multipart/form-data" method="post" action=""{{ request.urlgen('mediagoblin.plugins.dogma_extra_data.add_band') }}">

      {{ wtforms_util.render_divs(band_form) }}
      <div id="band">
        {% set country_input_name="band_country" %}
        {% include "dogma_extra_data/parts/countries.html"  %}
        <input class="postalcodeInput" name="band_postalcode" size="10" type="text">
        <input class="placeInput" name="band_place" size="30" type="hidden">
        <input class="latitude" name="band_latitude" size="30" type="hidden">
        <input class="longitude" name="band_longitude" size="30" type="hidden">
        <span class="placeDisplay"></span>
        <div  class="suggestBoxElement"></div>
        <p class="form_field_label"><label for="band_since">{% trans %}This band exists since{% endtrans %}</label></p>
        <div class="datePicker dateUnprocessed" >
          <input class="date_picker_input" name="band_since" type="hidden">
        </div>
      <h2>{% trans %}Band members{% endtrans %}</h2>
      </div>
      <div id="members">
        <div id="member_0">
          <h3>New Member</h3>
          {{ wtforms_util.render_divs(member_form) }}
          {% set country_input_name="member_country_0" %}
          {% include "dogma_extra_data/parts/countries.html" %}
          <input class="postalcodeInput" name="member_postalcode_0" size="10" type="text">
          <input class="placeInput" name="member_place_0" type="hidden">
          <input class="latitude" name="member_latitude_0" type="hidden">
          <input class="longitude" name="member_longitude_0" type="hidden">
          <span class="placeDisplay"></span>
          <div  class="suggestBoxElement"></div>
          <p class="form_field_label"><label for="member_since_0">{% trans %}Member Since{% endtrans %}</label></p>
          <div class="datePicker dateUnprocessed" >
            <input class="date_picker_input" name="member_since_0" type="hidden">
          </div>
        </div>
          <a id="button_add_member" class="button_action">+</a>
    </div>

      <div class="form_submit_buttons">
        {{ csrf_token }}
        <input type="submit" value="{% trans %}Just add the band{% endtrans %}" class="button_form" name="simple_submit"/>
        <input type="submit" value="{% trans %}Add the band and go add some tracks{% endtrans %}" class="button_form continue" name="submit_and_continue"/>
      </div>
  </form>
{% endblock %}
